{% extends "layouts/base.html" %}

{% block title %}Analytics Dashboard{% endblock %}

{% block content %}
<div class="container-fluid" x-data="dashboardApp()">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-graph-up"></i> Analytics Dashboard</h2>
        <div>
            <a href="{% url 'product_list' %}" class="btn btn-outline-primary">
                <i class="bi bi-box-seam"></i> Manage Products
            </a>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-currency-dollar display-4 text-success"></i>
                    <h6 class="text-muted mt-2">Total Sales</h6>
                    <h3 class="mb-0" x-text="'$' + overview.total_sales"></h3>
                    <small class="text-muted">Today: $<span x-text="overview.today_sales"></span></small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-receipt display-4 text-primary"></i>
                    <h6 class="text-muted mt-2">Total Orders</h6>
                    <h3 class="mb-0" x-text="overview.total_orders"></h3>
                    <small class="text-muted">Today: <span x-text="overview.today_orders"></span></small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-box display-4 text-warning"></i>
                    <h6 class="text-muted mt-2">Active Products</h6>
                    <h3 class="mb-0" x-text="overview.total_products"></h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-exclamation-triangle display-4 text-danger"></i>
                    <h6 class="text-muted mt-2">Low Stock</h6>
                    <h3 class="mb-0" x-text="overview.low_stock_count"></h3>
                    <small class="text-muted">Out: <span x-text="overview.out_of_stock_count"></span></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Products -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Top Selling Products</h5>
                </div>
                <div class="card-body">
                    <template x-if="topProducts.length > 0">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Qty Sold</th>
                                        <th>Revenue</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="product in topProducts" :key="product.product_id">
                                        <tr>
                                            <td x-text="product.product_name"></td>
                                            <td x-text="product.total_qty_sold"></td>
                                            <td class="text-success">$<span x-text="product.total_revenue"></span></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </template>
                    <template x-if="topProducts.length === 0">
                        <p class="text-muted text-center py-3">No sales data yet</p>
                    </template>
                </div>
            </div>
        </div>

        <!-- Low Stock Products -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Low Stock Alert</h5>
                </div>
                <div class="card-body">
                    <template x-if="lowStockProducts.length > 0">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Stock</th>
                                        <th>Threshold</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="product in lowStockProducts" :key="product.id">
                                        <tr :class="{'table-danger': product.is_out_of_stock}">
                                            <td x-text="product.name"></td>
                                            <td x-text="product.stock"></td>
                                            <td x-text="product.threshold"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </template>
                    <template x-if="lowStockProducts.length === 0">
                        <p class="text-muted text-center py-3">All products are well stocked</p>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function dashboardApp() {
    return {
        overview: {
            total_sales: '0.00',
            total_orders: 0,
            total_products: 0,
            low_stock_count: 0,
            out_of_stock_count: 0,
            today_sales: '0.00',
            today_orders: 0
        },
        topProducts: [],
        lowStockProducts: [],

        async init() {
            await this.loadOverview();
            await this.loadTopProducts();
            await this.loadLowStock();
        },

        async loadOverview() {
            try {
                const response = await fetch('/api/analytics/overview/');
                const data = await response.json();
                if (data.success) {
                    this.overview = data.overview;
                }
            } catch (error) {
                console.error('Error loading overview:', error);
            }
        },

        async loadTopProducts() {
            try {
                const response = await fetch('/api/analytics/top-products/?limit=5');
                const data = await response.json();
                if (data.success) {
                    this.topProducts = data.top_products;
                }
            } catch (error) {
                console.error('Error loading top products:', error);
            }
        },

        async loadLowStock() {
            try {
                const response = await fetch('/api/analytics/low-stock/');
                const data = await response.json();
                if (data.success) {
                    this.lowStockProducts = data.low_stock_products;
                }
            } catch (error) {
                console.error('Error loading low stock:', error);
            }
        }
    }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}
