{% extends 'base.html' %}

{% block title %}{{ action }} Product - FJC Pizza{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto space-y-6">
    <!-- Header -->
    <div>
        <h1 class="text-3xl font-bold text-gray-900">{{ action }} Product</h1>
        <p class="mt-1 text-sm text-gray-500">
            {% if product %}Update product details and inventory{% else %}Add a new product to your menu{% endif %}
        </p>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6">
        <form method="POST" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}

            <!-- Product Name -->
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
                    Product Name <span class="text-red-500">*</span>
                </label>
                <input
                    type="text"
                    id="name"
                    name="name"
                    value="{{ product.name|default:'' }}"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-fjc-blue-500 focus:border-fjc-blue-500"
                    placeholder="e.g., Margherita Pizza"
                />
                <p id="name-error" class="mt-1 text-sm text-red-600 hidden"></p>
            </div>

            <!-- Description -->
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                    Description
                </label>
                <textarea
                    id="description"
                    name="description"
                    rows="3"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-fjc-blue-500 focus:border-fjc-blue-500"
                    placeholder="Describe your product..."
                >{{ product.description|default:'' }}</textarea>
            </div>

            <!-- Price and Stock -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="price" class="block text-sm font-medium text-gray-700 mb-1">
                        Price (â‚±) <span class="text-red-500">*</span>
                    </label>
                    <input
                        type="number"
                        id="price"
                        name="price"
                        value="{{ product.price|default:'' }}"
                        step="0.01"
                        min="0.01"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-fjc-blue-500 focus:border-fjc-blue-500"
                        placeholder="0.00"
                    />
                    <p id="price-error" class="mt-1 text-sm text-red-600 hidden"></p>
                </div>

                <div>
                    <label for="stock" class="block text-sm font-medium text-gray-700 mb-1">
                        Stock Quantity <span class="text-red-500">*</span>
                    </label>
                    <input
                        type="number"
                        id="stock"
                        name="stock"
                        value="{{ product.stock|default:'0' }}"
                        min="0"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-fjc-blue-500 focus:border-fjc-blue-500"
                        placeholder="0"
                    />
                    <p id="stock-error" class="mt-1 text-sm text-red-600 hidden"></p>
                </div>
            </div>

            <!-- Threshold and Category -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="threshold" class="block text-sm font-medium text-gray-700 mb-1">
                        Low Stock Threshold
                    </label>
                    <input
                        type="number"
                        id="threshold"
                        name="threshold"
                        value="{{ product.threshold|default:'10' }}"
                        min="0"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-fjc-blue-500 focus:border-fjc-blue-500"
                        placeholder="10"
                    />
                    <p class="mt-1 text-xs text-gray-500">Alert when stock falls below this number</p>
                </div>

                <div class="relative">
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">
                        Category
                    </label>
                    <input
                        type="text"
                        id="category"
                        name="category"
                        value="{{ product.category|default:'' }}"
                        class="category-search w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-fjc-blue-500 focus:border-fjc-blue-500"
                        placeholder="e.g., Pizza, Drinks, Desserts"
                        autocomplete="off"
                    />
                    <div class="category-suggestions absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg hidden"></div>
                </div>
            </div>

            <!-- Image Upload -->
            <div>
                <label for="image" class="block text-sm font-medium text-gray-700 mb-1">
                    Product Image
                </label>
                {% if product.image %}
                <div class="mb-2">
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="h-32 rounded-lg border border-gray-200">
                </div>
                {% endif %}
                <input
                    type="file"
                    id="image"
                    name="image"
                    accept="image/*"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-fjc-blue-500 focus:border-fjc-blue-500"
                />
                <p class="mt-1 text-xs text-gray-500">Upload a product image (JPG, PNG, etc.)</p>
            </div>

            <!-- Recipe/BOM Section (only for editing) -->
            {% if product %}
            <div class="pt-6 border-t border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Recipe (Bill of Materials)</h3>
                        <p class="text-sm text-gray-500 mt-1">Define ingredients and quantities for this product</p>
                    </div>
                    <a href="{% url 'products:recipe_edit' product.id %}" class="px-4 py-2 bg-fjc-blue-600 text-white rounded-lg hover:bg-fjc-blue-700 font-medium text-sm">
                        âž• Manage Recipe
                    </a>
                </div>

                <!-- Recipe Preview -->
                <div class="bg-gray-50 rounded-lg border border-gray-200 p-4">
                    {% if product.recipe.ingredients.all %}
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="border-b border-gray-300">
                                <tr>
                                    <th class="text-left py-2 px-3 font-semibold text-gray-700">Ingredient</th>
                                    <th class="text-right py-2 px-3 font-semibold text-gray-700">Quantity</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for item in product.recipe.ingredients.all %}
                                <tr>
                                    <td class="py-2 px-3">{{ item.ingredient.name }}</td>
                                    <td class="py-2 px-3 text-right">{{ item.quantity }} {{ item.ingredient.unit }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-6">
                        <span class="text-3xl mb-2 block">ðŸ“‹</span>
                        <p class="text-gray-600 mb-4">No recipe defined yet</p>
                        <a href="{% url 'products:recipe_edit' product.id %}" class="text-fjc-blue-600 hover:text-fjc-blue-700 font-medium">
                            Create Recipe
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="flex space-x-3 pt-4">
                <button
                    type="submit"
                    class="flex-1 bg-fjc-blue-600 text-white px-6 py-3 rounded-lg hover:bg-fjc-blue-700 font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-fjc-blue-500"
                >
                    {{ action }} Product
                </button>
                <a
                    href="{% url 'products:list' %}"
                    class="flex-1 bg-gray-200 text-gray-800 px-6 py-3 rounded-lg hover:bg-gray-300 font-medium text-center shadow-sm"
                >
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const nameInput = document.getElementById('name');
    const priceInput = document.getElementById('price');
    const stockInput = document.getElementById('stock');

    // Validation functions
    function validateName() {
        const value = nameInput.value.trim();
        const errorEl = document.getElementById('name-error');

        if (!value) {
            showError(nameInput, errorEl, 'Product name is required');
            return false;
        } else if (value.length < 2) {
            showError(nameInput, errorEl, 'Product name must be at least 2 characters');
            return false;
        } else {
            clearError(nameInput, errorEl);
            return true;
        }
    }

    function validatePrice() {
        const value = parseFloat(priceInput.value);
        const errorEl = document.getElementById('price-error');

        if (!priceInput.value) {
            showError(priceInput, errorEl, 'Price is required');
            return false;
        } else if (isNaN(value) || value <= 0) {
            showError(priceInput, errorEl, 'Price must be greater than 0');
            return false;
        } else if (value > 99999) {
            showError(priceInput, errorEl, 'Price must be less than â‚±99,999');
            return false;
        } else {
            clearError(priceInput, errorEl);
            return true;
        }
    }

    function validateStock() {
        const value = parseInt(stockInput.value);
        const errorEl = document.getElementById('stock-error');

        if (!stockInput.value && stockInput.value !== '0') {
            showError(stockInput, errorEl, 'Stock quantity is required');
            return false;
        } else if (isNaN(value) || value < 0) {
            showError(stockInput, errorEl, 'Stock must be 0 or greater');
            return false;
        } else if (value > 999999) {
            showError(stockInput, errorEl, 'Stock must be less than 1,000,000');
            return false;
        } else {
            clearError(stockInput, errorEl);
            return true;
        }
    }

    function showError(input, errorEl, message) {
        input.classList.remove('border-gray-300', 'focus:border-fjc-blue-500', 'focus:ring-fjc-blue-500');
        input.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
    }

    function clearError(input, errorEl) {
        input.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        input.classList.add('border-gray-300', 'focus:border-fjc-blue-500', 'focus:ring-fjc-blue-500');
        errorEl.textContent = '';
        errorEl.classList.add('hidden');
    }

    // Add event listeners for real-time validation
    nameInput.addEventListener('blur', validateName);
    nameInput.addEventListener('input', function() {
        if (nameInput.value.trim()) {
            validateName();
        }
    });

    priceInput.addEventListener('blur', validatePrice);
    priceInput.addEventListener('input', function() {
        if (priceInput.value) {
            validatePrice();
        }
    });

    stockInput.addEventListener('blur', validateStock);
    stockInput.addEventListener('input', function() {
        if (stockInput.value) {
            validateStock();
        }
    });

    // Validate on form submit
    form.addEventListener('submit', function(e) {
        const isNameValid = validateName();
        const isPriceValid = validatePrice();
        const isStockValid = validateStock();

        if (!isNameValid || !isPriceValid || !isStockValid) {
            e.preventDefault();

            // Scroll to first error
            const firstError = document.querySelector('.border-red-500');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }
    });
});

// ========== Category Async Search ==========
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

async function searchCategories(input) {
    const query = input.value.trim();
    const suggestionsDiv = input.parentElement.querySelector('.category-suggestions');

    if (!query || query.length < 1) {
        suggestionsDiv.classList.add('hidden');
        return;
    }

    try {
        const response = await fetch(`/products/api/search-categories/?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data.results.length === 0) {
            suggestionsDiv.innerHTML = '<div class="p-3 text-sm text-gray-500">No categories found</div>';
            suggestionsDiv.classList.remove('hidden');
            return;
        }

        let html = '';
        data.results.forEach(category => {
            html += `
                <div class="category-suggestion p-3 hover:bg-fjc-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition"
                     data-name="${category.name}">
                    <div class="font-medium text-gray-900">${category.name}</div>
                </div>
            `;
        });

        suggestionsDiv.innerHTML = html;
        suggestionsDiv.classList.remove('hidden');

        // Add click handlers to suggestions
        suggestionsDiv.querySelectorAll('.category-suggestion').forEach(suggestion => {
            suggestion.addEventListener('click', () => {
                input.value = suggestion.dataset.name;
                suggestionsDiv.classList.add('hidden');
            });
        });

    } catch (error) {
        console.error('Error searching categories:', error);
        suggestionsDiv.innerHTML = '<div class="p-3 text-sm text-red-500">Error searching categories</div>';
        suggestionsDiv.classList.remove('hidden');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const categoryInput = document.querySelector('.category-search');

    if (categoryInput) {
        categoryInput.addEventListener('input', debounce(() => searchCategories(categoryInput), 300));
        categoryInput.addEventListener('focus', () => {
            if (categoryInput.value.trim().length > 0) {
                searchCategories(categoryInput);
            }
        });

        // Hide suggestions when clicking outside
        categoryInput.addEventListener('blur', () => {
            setTimeout(() => {
                categoryInput.parentElement.querySelector('.category-suggestions').classList.add('hidden');
            }, 200);
        });
    }
});
</script>
{% endblock %}
